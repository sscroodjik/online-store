<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
    <div class="container" id="products"></div>

    <div id="chat">
        <h2>üí¨ –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h2>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <script>
        const GRAPHQL_URL = 'http://localhost:9080/graphql';

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å GraphQL
        function loadProducts() {
            const query = `
                query {
                    products(fields: ["name", "price"]) {
                        name
                        price
                    }
                }
            `;
            fetch(GRAPHQL_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            })
            .then(response => response.json())
            .then(data => {
                const products = data.data.products;
                const productsContainer = document.getElementById('products');
                productsContainer.innerHTML = '';  // –û—á–∏—Å—Ç–∏—Ç—å –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º

                products.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.classList.add('card');
                    productCard.innerHTML = `
                        <h2>${product.name}</h2>
                       
                        <p class="price">${product.price} —Ä—É–±.</p>
                    `;
                    productsContainer.appendChild(productCard);
                });
            })
            .catch(error => {
                document.getElementById('products').innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤: ${error.message}</p>`;
            });
        }

        loadProducts();  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

        // –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π —Å–ª—É–∂–±—ã
        const socket = new WebSocket('ws://localhost:9070');
        let userId = null;

        socket.onmessage = (event) => {
            const msgDiv = document.createElement('div');
            msgDiv.textContent = event.data;
            document.getElementById('messages').appendChild(msgDiv);

            // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (!userId && event.data.startsWith('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!')) {
                userId = event.data.split(': ')[1];  // –ò–∑–≤–ª–µ–∫–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        function sendMessage() {
            const message = {
                user: userId ? `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å` : '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å',
                text: document.getElementById('messageInput').value
            };
            socket.send(JSON.stringify(message));
            document.getElementById('messageInput').value = '';
        }

    </script>
</body>
</html>
