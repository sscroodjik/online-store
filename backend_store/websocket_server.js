const WebSocket = require('ws');
const { v4: uuidv4 } = require('uuid');  // ะะปั ะณะตะฝะตัะฐัะธะธ ัะฝะธะบะฐะปัะฝัั ะธะดะตะฝัะธัะธะบะฐัะพัะพะฒ

const PORT = 9070;
const wss = new WebSocket.Server({ port: PORT });

// ะฅัะฐะฝะธะผ ัะพะพะฑัะตะฝะธั ัะพะปัะบะพ ะดะปั ัะตะบััะตะณะพ ัะตะฐะฝัะฐ
let messages = [];

wss.on('connection', (ws) => {
    // ะะตะฝะตัะฐัะธั ัะฝะธะบะฐะปัะฝะพะณะพ ID ะดะปั ะฝะพะฒะพะณะพ ะบะปะธะตะฝัะฐ
    const userId = uuidv4();
    console.log(`๐ ะะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพะดะบะปััะธะปัั`);

    // ะัะฟัะฐะฒะปัะตะผ ะฟัะธะฒะตัััะฒะตะฝะฝะพะต ัะพะพะฑัะตะฝะธะต ะธ ัะฝะธะบะฐะปัะฝัะน ID
    ws.send(`ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั!`);

    // ะัะธัะฐะตะผ ะธััะพัะธั ัะพะพะฑัะตะฝะธะน ะฟัะธ ะบะฐะถะดะพะผ ะฝะพะฒะพะผ ะฟะพะดะบะปััะตะฝะธะธ
    messages = [];  // ะัะต ัะพะพะฑัะตะฝะธั ะพัะธัะฐัััั ะฟัะธ ะฟะพะดะบะปััะตะฝะธะธ ะฝะพะฒะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั

    // ะกะพะพะฑัะฐะตะผ ะฟะพะดะบะปััะตะฝะฝะพะผั ะฟะพะปัะทะพะฒะฐัะตะปั ะพ ะฝะพะฒะพะผ ัะพะพะฑัะตะฝะธะธ, ะตัะปะธ ะพะฝะพ ะตััั
    messages.forEach(msg => ws.send(`${msg.time} | ${msg.user}: ${msg.text}`));

    // ะะฑัะฐะฑะพัะบะฐ ะฒัะพะดััะธั ัะพะพะฑัะตะฝะธะน ะพั ะบะปะธะตะฝัะฐ
    ws.on('message', (message) => {
        const msg = JSON.parse(message);
        const newMessage = {
            user: msg.user || 'ะะฝะพะฝะธะผ',
            text: msg.text,
            time: new Date().toLocaleTimeString(),
        };

        // ะะพะฑะฐะฒะปัะตะผ ะฝะพะฒะพะต ัะพะพะฑัะตะฝะธะต ะฒ ะฟะฐะผััั
        messages.push(newMessage);
        console.log(`๐ฌ ${newMessage.user}: ${newMessage.text}`);

        // ะัะฟัะฐะฒะปัะตะผ ะฝะพะฒะพะต ัะพะพะฑัะตะฝะธะต ะฒัะตะผ ะฟะพะดะบะปััะตะฝะฝัะผ ะบะปะธะตะฝัะฐะผ
        wss.clients.forEach(client => {
            if (client.readyState === WebSocket.OPEN) {
                client.send(`${newMessage.time} | ${newMessage.user}: ${newMessage.text}`);
            }
        });
    });

    // ะะฑัะฐะฑะพัะบะฐ ะพัะบะปััะตะฝะธั ะบะปะธะตะฝัะฐ
    ws.on('close', () => {
        console.log(`๐ ะะพะปัะทะพะฒะฐัะตะปั ั ID ${userId} ะพัะบะปััะธะปัั`);
    });
});

console.log(`๐ฌ WebSocket ัะตัะฒะตั ัะฐะฑะพัะฐะตั ะฝะฐ ws://localhost:${PORT}`);
